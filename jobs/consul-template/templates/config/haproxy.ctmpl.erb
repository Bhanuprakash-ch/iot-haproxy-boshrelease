global
    log 127.0.0.1   syslog info
    daemon
    user vcap
    group vcap
    maxconn 64000
    spread-checks 4
    tune.ssl.default-dh-param <%= p("ha_proxy.default_dh_param") %>

defaults
    log global
    maxconn 64000
    option contstats
    timeout connect         <%= p("ha_proxy.connect_timeout").to_i    * 1000 %>ms
    timeout client          <%= p("ha_proxy.client_timeout").to_i     * 1000 %>ms
    timeout server          <%= p("ha_proxy.server_timeout").to_i     * 1000 %>ms
    timeout tunnel          <%= p("ha_proxy.websocket_timeout").to_i  * 1000 %>ms
    timeout queue           <%= p("ha_proxy.queue_timeout").to_i      * 1000 %>ms

listen web 127.0.0.1:80


{{range service "mosquitto"}}
frontend frontend-{{.ID}} 
    mode tcp
    bind :{{.Port}} ssl crt /var/vcap/jobs/haproxy/config/cert.pem no-sslv3 ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK
    default_backend backend-{{.ID}}

backend backend-{{.ID}}
    mode tcp
    server {{.Name}} {{.Address}}:{{.Port}} check inter 1000


{{end}}

